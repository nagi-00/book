<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bookshelves</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #E8E8ED;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px 20px;
    }

    .window {
      width: 100%;
      max-width: 480px;
      background: #FFFFFF;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      overflow: hidden;
    }

    /* Title Bar */
    .titlebar {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: #FFFFFF;
      border-bottom: 1px solid #F0F0F0;
      position: relative;
    }

    .traffic-lights {
      display: flex;
      gap: 8px;
    }

    .traffic-light {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .traffic-light.red { background: #e8bcbc; }
    .traffic-light.yellow { background: #f4f4bd; }
    .traffic-light.green { background: #c5e8c5; }

    .titlebar-title {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 13px;
      font-weight: 500;
      color: #1D1D1F;
    }

    .titlebar-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .titlebar-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #86868B;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
      transition: color 0.2s;
    }

    .titlebar-btn:hover {
      color: #1D1D1F;
    }

    .titlebar-btn.search-btn {
      position: relative;
    }

    .tooltip {
      position: absolute;
      top: calc(100% + 12px);
      right: 0;
      background: #1D1D1F;
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      pointer-events: none;
      z-index: 100;
    }

    .tooltip::before {
      content: '';
      position: absolute;
      top: -6px;
      right: 12px;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 6px solid #1D1D1F;
    }

    .titlebar-btn.search-btn:hover .tooltip {
      opacity: 1;
      visibility: visible;
    }

    /* Search Panel */
    .search-panel {
      display: none;
      padding: 16px;
      background: #FAFAFA;
      border-bottom: 1px solid #F0F0F0;
    }

    .search-panel.active {
      display: block;
    }

    .search-input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #E0E0E0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      background: #FFFFFF;
      transition: border-color 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: #007AFF;
    }

    .search-input::placeholder {
      color: #86868B;
    }

    /* Content */
    .content {
      height: 420px;
      overflow-y: auto;
      background: #FFFFFF;
    }

    .content::-webkit-scrollbar {
      width: 8px;
    }

    .content::-webkit-scrollbar-track {
      background: #F5F5F7;
    }

    .content::-webkit-scrollbar-thumb {
      background: #C7C7CC;
      border-radius: 4px;
    }

    .content::-webkit-scrollbar-thumb:hover {
      background: #A1A1A6;
    }

    /* Empty State */
    .empty-state {
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #86868B;
      padding: 40px;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.6;
    }

    .empty-text {
      font-size: 14px;
      text-align: center;
    }

    /* Book List */
    .book-list {
      padding: 8px;
    }

    .book-item {
      display: flex;
      gap: 14px;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .book-item:hover {
      background: #F5F5F7;
    }

    .book-cover {
      width: 48px;
      height: 68px;
      border-radius: 4px;
      object-fit: cover;
      background: #F0F0F0;
      flex-shrink: 0;
    }

    .book-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .book-title {
      font-size: 14px;
      font-weight: 500;
      color: #1D1D1F;
      margin-bottom: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.4;
    }

    .book-author {
      font-size: 12px;
      color: #86868B;
    }

    /* Loading */
    .loading {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #E0E0E0;
      border-top-color: #007AFF;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Detail View */
    .detail-view {
      display: none;
      height: 100%;
      flex-direction: column;
    }

    .detail-view.active {
      display: flex;
    }

    .detail-header {
      padding: 24px;
      display: flex;
      gap: 20px;
      border-bottom: 1px solid #F0F0F0;
    }

    .detail-cover {
      width: 80px;
      height: 112px;
      border-radius: 6px;
      object-fit: cover;
      background: #F0F0F0;
      flex-shrink: 0;
    }

    .detail-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .detail-title {
      font-size: 16px;
      font-weight: 600;
      color: #1D1D1F;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .detail-author {
      font-size: 13px;
      color: #86868B;
      margin-bottom: 4px;
    }

    .detail-publisher {
      font-size: 12px;
      color: #A1A1A6;
    }

    .detail-body {
      flex: 1;
      padding: 20px 24px;
      overflow-y: auto;
    }

    .detail-section {
      margin-bottom: 20px;
    }

    .detail-label {
      font-size: 11px;
      font-weight: 600;
      color: #86868B;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .detail-value {
      font-size: 13px;
      color: #1D1D1F;
      line-height: 1.6;
    }

    .detail-footer {
      padding: 16px 24px;
      border-top: 1px solid #F0F0F0;
    }

    .btn-add {
      width: 100%;
      padding: 12px;
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-add:hover {
      background: #0066D6;
    }

    .btn-add:disabled {
      background: #C7C7CC;
      cursor: not-allowed;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #1D1D1F;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 13px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s;
      z-index: 100;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    .toast.success { background: #34C759; }
    .toast.error { background: #FF3B30; }
  </style>
</head>

<body>
  <div class="window">
    <!-- Title Bar -->
    <div class="titlebar">
      <div class="traffic-lights">
        <div class="traffic-light red"></div>
        <div class="traffic-light yellow"></div>
        <div class="traffic-light green"></div>
      </div>
      <span class="titlebar-title">Bookshelves</span>
      <div class="titlebar-actions">
        <button class="titlebar-btn" id="backBtn" onclick="goBack()" style="display: none;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
        </button>
        <button class="titlebar-btn" id="sendBtn" onclick="addToNotion()" style="display: none;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </button>
        <button class="titlebar-btn search-btn" onclick="toggleSearch()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          <div class="tooltip">ÎèÑÏÑú Í≤ÄÏÉâ ÏúÑÏ†Ø. ü§ç ‚ìínagi. All rights reserved.</div>
        </button>
      </div>
    </div>

    <!-- Search Panel -->
    <div class="search-panel" id="searchPanel">
      <input
        type="text"
        class="search-input"
        id="searchInput"
        placeholder="Ï±Ö Ï†úÎ™©ÏùÑ Í≤ÄÏÉâÌïòÏÑ∏Ïöî..."
        onkeydown="handleKeydown(event)"
      />
    </div>

    <!-- Content -->
    <div class="content" id="content">
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">üìö</div>
        <div class="empty-text">Í≤ÄÏÉâ ÏïÑÏù¥ÏΩòÏùÑ ÎàåÎü¨<br>Ï±ÖÏùÑ Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî</div>
      </div>

      <div class="book-list" id="bookList" style="display: none;"></div>

      <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
      </div>

      <div class="detail-view" id="detailView">
        <div class="detail-header">
          <img class="detail-cover" id="detailCover" src="" alt="">
          <div class="detail-info">
            <div class="detail-title" id="detailTitle"></div>
            <div class="detail-author" id="detailAuthor"></div>
            <div class="detail-publisher" id="detailPublisher"></div>
          </div>
        </div>
        <div class="detail-body">
          <div class="detail-section" id="categorySection">
            <div class="detail-label">Ïû•Î•¥</div>
            <div class="detail-value" id="detailCategory"></div>
          </div>
          <div class="detail-section" id="descSection">
            <div class="detail-label">ÏÜåÍ∞ú</div>
            <div class="detail-value" id="detailDesc"></div>
          </div>
        </div>
        <div class="detail-footer">
          <button class="btn-add" onclick="addToNotion()">ÎÖ∏ÏÖòÏóê Ï∂îÍ∞Ä</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ÏÑ§Ï†ï
    const CONFIG = {
      ALADIN_TTB_KEY: 'ttb1995dianalee0217002',
      NOTION_TOKEN: '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',
      NOTION_DB_ID: '2f886273-8e61-818c-9326-000b91cdcfe8'
    };

    let books = [];
    let selectedBook = null;
    let currentView = 'list';

    function toggleSearch() {
      const panel = document.getElementById('searchPanel');
      panel.classList.toggle('active');
      if (panel.classList.contains('active')) {
        document.getElementById('searchInput').focus();
      }
    }

    function handleKeydown(e) {
      if (e.key === 'Enter') {
        searchBooks();
      }
    }

    // JSONPÎ°ú Aladin API Ìò∏Ï∂ú
    function searchBooks() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;

      showLoading();

      const callbackName = 'aladinCallback_' + Date.now();
      const url = 'https://www.aladin.co.kr/ttb/api/ItemSearch.aspx' +
        `?ttbkey=${CONFIG.ALADIN_TTB_KEY}` +
        `&Query=${encodeURIComponent(query)}` +
        '&QueryType=Title&MaxResults=10&SearchTarget=Book&output=js&Version=20131101' +
        `&callback=${callbackName}`;

      window[callbackName] = function(data) {
        delete window[callbackName];
        document.body.removeChild(script);

        if (!data || !data.item || data.item.length === 0) {
          showEmpty('Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§');
          return;
        }

        books = data.item.map(b => ({
          isbn: b.isbn13 || b.isbn,
          title: b.title,
          author: b.author,
          publisher: b.publisher,
          pubDate: b.pubDate,
          cover: b.cover?.replace('coversum', 'cover500') || b.cover,
          description: b.description,
          categoryName: b.categoryName,
          link: b.link
        }));

        renderBooks();
      };

      const script = document.createElement('script');
      script.src = url;
      script.onerror = function() {
        delete window[callbackName];
        document.body.removeChild(script);
        showEmpty('Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§');
      };
      document.body.appendChild(script);
    }

    function showLoading() {
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('bookList').style.display = 'none';
      document.getElementById('detailView').classList.remove('active');
      document.getElementById('loading').style.display = 'flex';
      document.getElementById('backBtn').style.display = 'none';
      document.getElementById('sendBtn').style.display = 'none';
      currentView = 'list';
    }

    function showEmpty(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('bookList').style.display = 'none';
      document.getElementById('detailView').classList.remove('active');
      document.getElementById('emptyState').style.display = 'flex';
      document.getElementById('emptyState').innerHTML = `
        <div class="empty-icon">üîç</div>
        <div class="empty-text">${message}</div>
      `;
      document.getElementById('backBtn').style.display = 'none';
      document.getElementById('sendBtn').style.display = 'none';
      currentView = 'list';
    }

    function renderBooks() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('detailView').classList.remove('active');
      document.getElementById('bookList').style.display = 'block';
      document.getElementById('backBtn').style.display = 'none';
      document.getElementById('sendBtn').style.display = 'none';
      currentView = 'list';

      const html = books.map((book, i) => `
        <div class="book-item" onclick="selectBook(${i})">
          <img class="book-cover" src="${book.cover || ''}" alt="" onerror="this.style.background='#F0F0F0'">
          <div class="book-info">
            <div class="book-title">${book.title}</div>
            <div class="book-author">${book.author}</div>
          </div>
        </div>
      `).join('');

      document.getElementById('bookList').innerHTML = html;
    }

    function selectBook(index) {
      selectedBook = books[index];
      showDetail();
    }

    function showDetail() {
      if (!selectedBook) return;

      document.getElementById('bookList').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('loading').style.display = 'none';
      document.getElementById('detailView').classList.add('active');
      document.getElementById('backBtn').style.display = 'block';
      document.getElementById('sendBtn').style.display = 'block';
      currentView = 'detail';

      document.getElementById('detailCover').src = selectedBook.cover || '';
      document.getElementById('detailTitle').textContent = selectedBook.title;
      document.getElementById('detailAuthor').textContent = selectedBook.author;
      document.getElementById('detailPublisher').textContent =
        `${selectedBook.publisher || ''} ${selectedBook.pubDate ? '¬∑ ' + selectedBook.pubDate : ''}`;

      if (selectedBook.categoryName) {
        document.getElementById('detailCategory').textContent = selectedBook.categoryName;
        document.getElementById('categorySection').style.display = 'block';
      } else {
        document.getElementById('categorySection').style.display = 'none';
      }

      if (selectedBook.description) {
        document.getElementById('detailDesc').textContent = selectedBook.description;
        document.getElementById('descSection').style.display = 'block';
      } else {
        document.getElementById('descSection').style.display = 'none';
      }
    }

    function goBack() {
      if (currentView === 'detail') {
        document.getElementById('sendBtn').style.display = 'none';
        renderBooks();
      }
    }

    async function addToNotion() {
      if (!selectedBook) return;

      const { title, author, cover, description } = selectedBook;

      const properties = {
        "title": {
          title: [{ text: { content: title || "" } }]
        },
        "author": {
          rich_text: [{ text: { content: author || "" } }]
        }
      };

      if (cover) {
        properties["cover"] = {
          files: [{
            type: "external",
            name: "cover.jpg",
            external: { url: cover }
          }]
        };
      }

      const body = {
        parent: { database_id: CONFIG.NOTION_DB_ID },
        properties: properties
      };

      if (cover) {
        body.cover = {
          type: "external",
          external: { url: cover }
        };
      }

      if (description) {
        body.children = [{
          object: "block",
          type: "quote",
          quote: {
            rich_text: [{ type: "text", text: { content: description.slice(0, 2000) } }]
          }
        }];
      }

      try {
        const res = await fetch('https://api.notion.com/v1/pages', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${CONFIG.NOTION_TOKEN}`,
            'Content-Type': 'application/json',
            'Notion-Version': '2022-06-28'
          },
          body: JSON.stringify(body)
        });

        const data = await res.json();

        if (res.ok) {
          showToast('ÎÖ∏ÏÖòÏóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!', 'success');
        } else {
          console.error('Notion error:', data);
          showToast(data.message || 'Ï∂îÍ∞Ä Ïã§Ìå®', 'error');
        }
      } catch (err) {
        console.error('Add error:', err);
        showToast('Ï∂îÍ∞Ä Ï§ë Ïò§Î•ò Î∞úÏÉù', 'error');
      }
    }

    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>
