<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bookshelves</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: #E8E8ED;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .window {
      width: 220px;
      background: #FFFFFF;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .titlebar {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      background: #FFFFFF;
      border-bottom: 1px solid #F0F0F0;
    }

    .traffic-lights {
      display: flex;
      gap: 5px;
    }

    .traffic-light {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .traffic-light.red { background: #e8bcbc; }
    .traffic-light.yellow { background: #f4f4bd; }
    .traffic-light.green { background: #c5e8c5; }

    .titlebar-title {
      flex: 1;
      text-align: center;
      font-size: 11px;
      font-weight: 500;
      color: #1D1D1F;
    }

    .titlebar-actions {
      display: flex;
      gap: 8px;
    }

    .titlebar-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #86868B;
      display: flex;
      align-items: center;
      padding: 2px;
      position: relative;
    }

    .titlebar-btn:hover { color: #1D1D1F; }

    .tooltip {
      position: absolute;
      top: calc(100% + 8px);
      right: -10px;
      background: #1D1D1F;
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 9px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s;
      z-index: 100;
    }

    .tooltip::before {
      content: '';
      position: absolute;
      top: -4px;
      right: 14px;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 4px solid #1D1D1F;
    }

    .titlebar-btn:hover .tooltip {
      opacity: 1;
      visibility: visible;
    }

    .search-panel {
      display: none;
      padding: 8px;
      background: #FAFAFA;
      border-bottom: 1px solid #F0F0F0;
    }

    .search-panel.active { display: block; }

    .search-input {
      width: 100%;
      padding: 6px 10px;
      border: 1px solid #E0E0E0;
      border-radius: 6px;
      font-size: 11px;
      font-family: inherit;
    }

    .search-input:focus {
      outline: none;
      border-color: #007AFF;
    }

    .content {
      height: 160px;
      overflow-y: auto;
      background: #FFFFFF;
    }

    .content::-webkit-scrollbar { width: 4px; }
    .content::-webkit-scrollbar-thumb { background: #D0D0D0; border-radius: 2px; }

    .empty-state {
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #86868B;
      padding: 20px;
    }

    .empty-icon { font-size: 28px; margin-bottom: 8px; }
    .empty-text { font-size: 10px; text-align: center; line-height: 1.4; }

    .book-list { padding: 4px; }

    .book-item {
      display: flex;
      gap: 8px;
      padding: 6px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .book-item:hover { background: #F5F5F7; }
    .book-item.adding { opacity: 0.5; pointer-events: none; }

    .book-cover {
      width: 28px;
      height: 40px;
      border-radius: 3px;
      object-fit: cover;
      background: #F0F0F0;
      flex-shrink: 0;
    }

    .book-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .book-title {
      font-size: 10px;
      font-weight: 500;
      color: #1D1D1F;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.3;
    }

    .book-author {
      font-size: 9px;
      color: #86868B;
      margin-top: 2px;
    }

    .loading {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #E0E0E0;
      border-top-color: #007AFF;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%) translateY(60px);
      background: #1D1D1F;
      color: white;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 10px;
      transition: transform 0.3s;
      z-index: 100;
    }

    .toast.show { transform: translateX(-50%) translateY(0); }
    .toast.success { background: #34C759; }
    .toast.error { background: #FF3B30; }
  </style>
</head>

<body>
  <div class="window">
    <div class="titlebar">
      <div class="traffic-lights">
        <div class="traffic-light red"></div>
        <div class="traffic-light yellow"></div>
        <div class="traffic-light green"></div>
      </div>
      <span class="titlebar-title">Bookshelves</span>
      <div class="titlebar-actions">
        <button class="titlebar-btn" onclick="toggleSearch()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          <div class="tooltip">ÎèÑÏÑú Í≤ÄÏÉâ ÏúÑÏ†Ø. ü§ç ‚ìínagi. All rights reserved.</div>
        </button>
      </div>
    </div>

    <div class="search-panel" id="searchPanel">
      <input type="text" class="search-input" id="searchInput" placeholder="Ï±Ö Ï†úÎ™© Í≤ÄÏÉâ..." onkeydown="if(event.key==='Enter')searchBooks()">
    </div>

    <div class="content" id="content">
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">üìö</div>
        <div class="empty-text">Í≤ÄÏÉâ ÌõÑ ÌÅ¥Î¶≠ÌïòÎ©¥<br>ÎÖ∏ÏÖòÏóê ÏûêÎèô Ï∂îÍ∞ÄÎê©ÎãàÎã§</div>
      </div>
      <div class="book-list" id="bookList" style="display: none;"></div>
      <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const CONFIG = {
      ALADIN_TTB_KEY: 'ttb1995dianalee0217002',
      NOTION_TOKEN: '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',
      NOTION_DB_ID: '2f886273-8e61-818c-9326-000b91cdcfe8'
    };

    let books = [];

    function toggleSearch() {
      const panel = document.getElementById('searchPanel');
      panel.classList.toggle('active');
      if (panel.classList.contains('active')) {
        document.getElementById('searchInput').focus();
      }
    }

    function searchBooks() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;

      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('bookList').style.display = 'none';
      document.getElementById('loading').style.display = 'flex';

      const cbName = 'cb' + Date.now();
      const script = document.createElement('script');

      window[cbName] = function(data) {
        delete window[cbName];
        if (script.parentNode) script.parentNode.removeChild(script);

        document.getElementById('loading').style.display = 'none';

        if (!data || !data.item || data.item.length === 0) {
          document.getElementById('emptyState').style.display = 'flex';
          document.getElementById('emptyState').innerHTML = '<div class="empty-icon">üîç</div><div class="empty-text">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
          return;
        }

        books = data.item.map(b => ({
          title: b.title,
          author: b.author,
          cover: (b.cover || '').replace('coversum', 'cover500'),
          description: b.description || ''
        }));

        renderBooks();
      };

      script.src = 'https://www.aladin.co.kr/ttb/api/ItemSearch.aspx' +
        '?ttbkey=' + CONFIG.ALADIN_TTB_KEY +
        '&Query=' + encodeURIComponent(query) +
        '&QueryType=Title&MaxResults=10&SearchTarget=Book&output=js&Version=20131101' +
        '&callback=' + cbName;

      script.onerror = function() {
        delete window[cbName];
        if (script.parentNode) script.parentNode.removeChild(script);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('emptyState').style.display = 'flex';
        document.getElementById('emptyState').innerHTML = '<div class="empty-icon">‚ö†Ô∏è</div><div class="empty-text">Í≤ÄÏÉâ Ïò§Î•ò</div>';
      };

      document.body.appendChild(script);
    }

    function renderBooks() {
      const list = document.getElementById('bookList');
      list.style.display = 'block';
      list.innerHTML = books.map((b, i) => `
        <div class="book-item" id="book${i}" onclick="addBook(${i})">
          <img class="book-cover" src="${b.cover}" onerror="this.style.background='#F0F0F0'">
          <div class="book-info">
            <div class="book-title">${b.title}</div>
            <div class="book-author">${b.author}</div>
          </div>
        </div>
      `).join('');
    }

    async function addBook(index) {
      const book = books[index];
      const el = document.getElementById('book' + index);
      el.classList.add('adding');

      try {
        const res = await fetch('/addBook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(book)
        });
        const data = await res.json();

        if (data.ok) {
          showToast('Ï∂îÍ∞Ä ÏôÑÎ£å!', 'success');
          el.style.display = 'none';
        } else {
          throw new Error(data.error);
        }
      } catch (err) {
        el.classList.remove('adding');
        showToast('Ï∂îÍ∞Ä Ïã§Ìå®', 'error');
      }
    }

    function showToast(msg, type) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast show ' + type;
      setTimeout(() => t.classList.remove('show'), 2000);
    }
  </script>
</body>
</html>
